import React, { useEffect, useState } from "react";
import Counter from "./countDown";
import LogoImg from "../assets/image/logo.png";
import * as Web3Utils from 'web3-utils';
import Web3Modal from "web3modal";
import Web3 from "web3";
import WalletConnect from "@walletconnect/web3-provider";
import { getContractInstance } from '../contracts/lotteryInstance';
import abi from '../contracts/abi'
import RNG_abi from '../contracts/RNG_abi'
import Stack from "@mui/material/Stack";
import Paper from "@mui/material/Paper";
import Box from "@mui/material/Box";
import Button from "@mui/material/Button";
import Table from "@mui/material/Table";
import TableBody from "@mui/material/TableBody";
import TableCell from "@mui/material/TableCell";
import TableContainer from "@mui/material/TableContainer";
import TableHead from "@mui/material/TableHead";
import TableRow from "@mui/material/TableRow";
import Modal from "@mui/material/Modal";
import {
  getChildLists,
  addNewChild,
  removeChild,
} from "./utils";

export default function Ticket() {
  const [lotteryIdForClose, setLotteryIdForClose] = useState(1);
  const [lotteryIdForView, setLotteryIdForView] = useState(1);
  const [lotteryIdForClaim, setLotteryIdForClaim] = useState(1);
  const [totalRound, setTotalRound] = useState(1);
  const [winningNumber, setWinningNumber] = useState("");
  const [privKey, setPrivKey] = useState("");
  const [autoInterval, setAutoInterval] = useState(480);
  const [interval, setInterval] = useState(480);
  const [deployedAddress, setDeployedAddress] = useState("");
  const [lotteryInfo, setLotteryInfo] = useState([]);
  const [childLists, setChildLists] = useState([]);
  const [modalOpen, setModalOpen] = useState(false);
  const [settingModalOpen, setSettingModalOpen] = useState(false);
  const [childName, setChildName] = useState("");
  const [buttonIndex, setButtonIndex] = useState(0);
  const [currentContractAddress, setCurrentContractAddress] = useState("");
  const [RNGInstance, setRNGInstance] = useState("");
  const [LotteryInstance, setLotteryInstance] = useState("");
  const [walletArray, setWalletArray] = useState("");
  const [web3Data, setWeb3Data] = useState({
    fetching: false,
    address: "",
    web3: null,
    provider: null,
    connected: false,
    chainId: 1,
    networkId: 1,
    contract: null,
    lotteryInfo: []
  });
  const INITIAL_STATE = {
    fetching: false,
    address: "",
    web3: null,
    provider: null,
    connected: false,
    chainId: 1,
    networkId: 1,
    contract: null,
    lotteryInfo: []
  };

  const modalStyle = {
    position: "absolute",
    top: "50%",
    left: "50%",
    transform: "translate(-50%, -50%)",
    width: 400,
    bgcolor: "background.paper",
    border: "2px solid #000",
    boxShadow: 24,
    p: 4,
  };

  const modalStyle1 = {
    position: "absolute",
    top: "50%",
    left: "50%",
    transform: "translate(-50%, -50%)",
    width: 1200,
    bgcolor: "background.paper",
    border: "2px solid #000",
    boxShadow: 24,
    p: 4,
  };


  // const getNetwork = () => getChainData(this.state.chainId).network;
  const getProviderOptions = () => {
    const infuraId = "00ca1859789d4b40bce01f4104844224";
    const providerOptions = {
      walletconnect: {
        package: WalletConnect,
        options: {
          network: "binance",
          rpc: {
            56: "https://bsc-dataseed1.binance.org"
          }
        }
      }
    };
    return providerOptions;
  };

  const web3Modal = new Web3Modal({
    network: "Binance",
    cacheProvider: true,
    providerOptions: getProviderOptions(),
  });

  useEffect(() => {
    if (web3Modal.cachedProvider) {
      onConnect();
      updateChildren();
    }
  }, []);

  function ellipseAddress(
    address = "",
    width = 10
  ) {
    return `${address.slice(0, width)}...${address.slice(-width)}`;
  }
  const resetApp = async () => {
    const { web3 } = web3Data;
    if (web3 && web3.currentProvider && web3.currentProvider.close) {
      await web3.currentProvider.close();
    }
    await web3Modal.clearCachedProvider();
    setWeb3Data({ ...INITIAL_STATE });
  };

  const subscribeProvider = async (provider) => {
    if (!provider.on) {
      return;
    }
    provider.on("close", () => resetApp());
    provider.on("accountsChanged", async (accounts) => {
      console.log(accounts[0])
      setWeb3Data({ ...web3Data, address: accounts[0] });
      // await this.getAccountAssets();
    });
    provider.on("chainChanged", async (chainId) => {
      const { web3 } = web3Data;
      const networkId = await web3.eth.net.getId();
      setWeb3Data({ ...web3Data, chainId: chainId, networkId: networkId });
      // await this.getAccountAssets();
    });

    provider.on("networkChanged", async (networkId) => {
      const { web3 } = web3Data;
      const chainId = await web3.eth.chainId();
      setWeb3Data({ ...web3Data, chainId: chainId, networkId: networkId });
      // await this.getAccountAssets();
    });
  };
  function initWeb3(provider) {
    const web3 = new Web3(provider);

    web3.eth.extend({
      methods: [
        {
          name: "chainId",
          call: "eth_chainId",
          outputFormatter: web3.utils.hexToNumber
        }
      ]
    });

    return web3;
  }


  const onConnect = async () => {
    try {
      const provider = await web3Modal.connect();
      await subscribeProvider(provider);

      await provider.enable();
      const web3 = initWeb3(provider);

      const curChainId = await provider.request({ method: 'eth_chainId' });
      const binanceTestChainId = '0x61'
      if (curChainId === binanceTestChainId) {
        console.log("Bravo!, you are on the correct network");
      } else {
        try {
          await provider.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: '0x61' }],
          });
          console.log("You have succefully switched to Binance Test network")
        } catch (switchError) {
          // This error code indicates that the chain has not been added to MetaMask.
          if (switchError.code === 4902) {
            try {
              await provider.request({
                method: 'wallet_addEthereumChain',
                params: [
                  {
                    chainId: '0x61',
                    chainName: 'Binance Smart Chain Testnet',
                    rpcUrls: ['https://data-seed-prebsc-1-s1.binance.org:8545/'],
                    blockExplorerUrls: ['https://testnet.bscscan.com/'],
                    nativeCurrency: {
                      symbol: 'BNB',
                      decimals: 18,
                    }
                  }
                ]
              });
            } catch (addError) {
              console.log(addError);
              // alert(addError);
            }
          }
          // alert("Failed to switch to the network")
          return;
        }
      }

      const accounts = await web3.eth.getAccounts();
      const address = accounts[0];

      const networkId = await web3.eth.net.getId();

      const chainId = await web3.eth.chainId();
      const contract = await getContractInstance("0xF0a65A27688E65406E3fF9a44516c985E909F06d");

      const curLotteryId = await contract.getCurrentLotteryId();
      const lotteryInfo = await contract.getLotteryInfo(curLotteryId);
      setWeb3Data({
        web3,
        provider,
        connected: true,
        address,
        chainId,
        networkId,
        contract,
        lotteryInfo
      });
      setTotalRound(curLotteryId);
      setLotteryIdForClose(curLotteryId);
      setLotteryIdForClaim(curLotteryId);
      // await this.getAccountAssets();
    } catch (e) {
      console.log(e);
    }
  };

  const closeLottery = async () => {
    await web3Data.contract.closeLottery(web3Data.address, lotteryIdForClose);
  }

  const startLottery = async () => {
    const curTime = new Date().getTime();
    const endTime = parseInt(curTime / 1000);
    await web3Data.contract.startLottery(web3Data.address, endTime + interval * 60);
  }

  const finalizeLottery = async () => {
    const isManual = winningNumber.length != 0;
    const numbers = winningNumber.split(" ");
    let winNumber = [];
    if (isManual)
      winNumber.push(numbers);
    else {
      let zeroArray = ["0", "0", "0", "0", "0", "0"];
      winNumber.push(zeroArray);
    }
    console.log(winNumber);
    await web3Data.contract.drawFinalNumberAndMakeLotteryClaimable(web3Data.address, lotteryIdForClaim, isManual, winNumber);
  }

  const confirmAutomation = () => {

  }
  const confirmWallet = async () => {
    const wallets = walletArray.split(",");
    console.log(wallets);
    await web3Data.contract.setOperatorAndTreasuryAndInjectorAddresses(web3Data.address, web3Data.address, wallets);
  }

  const updateChildren = async () => {
    getChildLists().then((myChildList) => {
      console.log(myChildList);
      let newArr = [];
      myChildList.map((row) => {
        console.log(row);
        newArr.push({
          name: row.name,
          address: row.address,
        });
      });
      setChildLists(newArr);
    });
  };

  const handleRemoveChild = async (walletAddress) => {
    if (walletAddress === "0xF0a65A27688E65406E3fF9a44516c985E909F06d") {
      alert("Cannot delete main lottery");
      return;
    }
    removeChild(walletAddress);
    setTimeout(() => {
      updateChildren();
    }, 1000);
  };

  const setLotteryAddress = async () => {
    let account = web3Data.address;
    let parameter = {
      from: account,
      // gas: web3Data.web3.utils.toHex(800000),
      // gasPrice: web3Data.web3.utils.toHex(web3Data.web3.utils.toWei('30', 'gwei'))
    }
    RNGInstance.methods.setLotteryAddress(LotteryInstance.options.address).send(parameter, (err, transactionHash) => {
      console.log('Transaction Hash :', transactionHash);
    }).on('confirmation', () => { }).then((contractInstance) => {
      setButtonIndex(5);
      addNewChild(childName, LotteryInstance.options.address);
      setTimeout(() => {
        updateChildren();
      }, 1000);
      setChildName("");
      setRNGInstance("");
      setLotteryInstance("");
      setButtonIndex(0);
      handleModalClose();
    })
  }
  const deployLottery = async () => {
    let bytecode = '60806040523480156200001157600080fd5b5060405162004545380380620045458339810160408190526200003491620000ed565b6001600081815581546001600160a01b031916339081179092556040518291907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0908290a350601580546001600160a01b039384166001600160a01b03199182161790915560168054929093169181169190911790915560178054909116730567f2323251f0aab15c8dfb1967e4e8a7d42aee17905562000125565b80516001600160a01b0381168114620000e857600080fd5b919050565b600080604083850312156200010157600080fd5b6200010c83620000d0565b91506200011c60208401620000d0565b90509250929050565b61441080620001356000396000f3fe60806040526004361061023a5760003560e01c80637673faf01161012e578063b0ea7090116100ab578063dcbad90d1161006f578063dcbad90d14610691578063e359ebec146106b1578063e49eb0da146106c4578063f2fde38b146106e4578063f78d9b501461070457600080fd5b8063b0ea709014610604578063c5f956af14610624578063c6bec93a14610644578063cf7b8c5f14610664578063db19da0d1461067a57600080fd5b80638fc3539a116100f25780638fc3539a1461055657806398359fa1146105845780639c384653146105a45780639d8ca531146105c4578063a35446a9146105e457600080fd5b80637673faf0146104c957806380a06160146104e95780638adcc972146104fe5780638da5cb5b1461051e5780638e15f4731461053c57600080fd5b80632423807a116101bc5780635f88ffed116101805780635f88ffed1461045557806363f79ccc14610475578063686465b8146104885780636be4097c1461049e578063715018a6146104b457600080fd5b80632423807a146103a8578063392eac85146103d55780633c918bae146103f55780633f138d4b1461041557806341ab7d0f1461043557600080fd5b8063127effb211610203578063127effb21461031257806312a9769d1461033257806316993d09146103485780631a026c96146103685780632149485d1461038857600080fd5b806219889a1461023f57806304f35dd71461026157806305531eeb1461029e57806307fb5a9c146102ce5780630b8d0a28146102f2575b600080fd5b34801561024b57600080fd5b5061025f61025a366004613ccb565b610724565b005b34801561026d57600080fd5b50600b54610281906001600160a01b031681565b6040516001600160a01b0390911681526020015b60405180910390f35b3480156102aa57600080fd5b506102be6102b9366004613b1a565b61120d565b6040516102959493929190613e82565b3480156102da57600080fd5b506102e461371481565b604051908152602001610295565b3480156102fe57600080fd5b50600654610281906001600160a01b031681565b34801561031e57600080fd5b50600354610281906001600160a01b031681565b34801561033e57600080fd5b506102e460145481565b34801561035457600080fd5b50600c54610281906001600160a01b031681565b34801561037457600080fd5b50600554610281906001600160a01b031681565b34801561039457600080fd5b506102e46103a3366004613d1e565b61151e565b3480156103b457600080fd5b506103c86103c3366004613bce565b6115a3565b6040516102959190613feb565b3480156103e157600080fd5b50600f54610281906001600160a01b031681565b34801561040157600080fd5b50600754610281906001600160a01b031681565b34801561042157600080fd5b5061025f610430366004613af0565b611720565b34801561044157600080fd5b50600954610281906001600160a01b031681565b34801561046157600080fd5b50600e54610281906001600160a01b031681565b61025f610483366004613c00565b611802565b34801561049457600080fd5b506102e460115481565b3480156104aa57600080fd5b506102e460105481565b3480156104c057600080fd5b5061025f611cf4565b3480156104d557600080fd5b50600854610281906001600160a01b031681565b3480156104f557600080fd5b506010546102e4565b34801561050a57600080fd5b50600d54610281906001600160a01b031681565b34801561052a57600080fd5b506001546001600160a01b0316610281565b34801561054857600080fd5b50662386f26fc100006102e4565b34801561056257600080fd5b50610576610571366004613b53565b611d68565b604051610295929190613e54565b34801561059057600080fd5b5061025f61059f366004613a5f565b611f4c565b3480156105b057600080fd5b50600254610281906001600160a01b031681565b3480156105d057600080fd5b5061025f6105df366004613bce565b61213a565b3480156105f057600080fd5b5061025f6105ff366004613a7a565b612342565b34801561061057600080fd5b50600a54610281906001600160a01b031681565b34801561063057600080fd5b50600454610281906001600160a01b031681565b34801561065057600080fd5b5061025f61065f366004613bce565b6127e8565b34801561067057600080fd5b506102e460125481565b34801561068657600080fd5b506102e46205472c81565b34801561069d57600080fd5b50601654610281906001600160a01b031681565b61025f6106bf366004613bce565b612c0b565b3480156106d057600080fd5b5061025f6106df366004613c7f565b612d35565b3480156106f057600080fd5b5061025f6106ff366004613a5f565b6130dc565b34801561071057600080fd5b50601554610281906001600160a01b031681565b6003546001600160a01b031633146107575760405162461bcd60e51b815260040161074e90613fc5565b60405180910390fd5b6002600054141561077a5760405162461bcd60e51b815260040161074e90613f8e565b600260008181558581526018602052604090205460ff1660038111156107a2576107a2614387565b146107e35760405162461bcd60e51b81526020600482015260116024820152704c6f7474657279206e6f7420636c6f736560781b604482015260640161074e565b601660009054906101000a90046001600160a01b03166001600160a01b031663fbe5d9176040518163ffffffff1660e01b815260040160206040518083038186803b15801561083157600080fd5b505afa158015610845573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906108699190613be7565b84146108ab5760405162461bcd60e51b8152602060048201526011602482015270273ab6b132b939903737ba10323930bbb760791b604482015260640161074e565b6001821515141561092b576108bf816131c7565b6108fb5760405162461bcd60e51b815260206004820152600d60248201526c4f7574736964652072616e676560981b604482015260640161074e565b6000848152601860208190526040909120825183929190910190610922908290600661387a565b50905050610a9f565b601654604080516350e27aad60e11b815290516000926001600160a01b03169163a1c4f55a916004808301926020929190829003018186803b15801561097057600080fd5b505afa158015610984573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906109a89190613d40565b90506109b26138b8565b60005b60068163ffffffff161015610a3557604160646109d383600a61419a565b6109dd9086614132565b6109e79190614338565b6109f19190614338565b6109fc9060016140f6565b63ffffffff1682600001518263ffffffff1660068110610a1e57610a1e61439d565b602002015280610a2d81614300565b9150506109b5565b50805160a00151604190610a4a904290614283565b610a549190614324565b610a5f9060016140de565b815160a001526000610a70826132a1565b600088815260186020819052604090912082519293508392910190610a98908290600661387a565b5050505050505b6000848152601860205260408120805460ff191660031781556017015461271090610acc90611770614283565b610ad6919061411e565b600086815260186020526040812060150154919250905b600087815260186020526040902060160154811015610bfe576000878152601860208181526040808420815160e0810192839052610ba29490939101918391820190839060069082845b815481526020019060010190808311610b375750505091909252505050600084815260196020908152604091829020825160e0810190935290829081018260068282826020028201915b815481526020019060010190808311610b8157505050505081525050613464565b90508015610beb576000888152601860205260409020600f01610bc66001836142a2565b60068110610bd657610bd661439d565b018054906000610be5836142e5565b91905055505b5080610bf6816142e5565b915050610aed565b5060005b60068163ffffffff161015610da4576000878152601860205260409020600f0163ffffffff821660068110610c3957610c3961439d565b015415610d1757600087815260186020526040902060030163ffffffff821660068110610c6857610c6861439d565b015415610d1257600087815260186020526040902061271090600f0163ffffffff831660068110610c9b57610c9b61439d565b01546000898152601860205260409020859060030163ffffffff851660068110610cc757610cc761439d565b0154610cd39190614283565b610cdd919061411e565b610ce7919061411e565b600088815260186020526040902060090163ffffffff831660068110610d0f57610d0f61439d565b01555b610d92565b600087815260186020526040812060090163ffffffff831660068110610d3f57610d3f61439d565b0155600087815260186020526040902061271090849060030163ffffffff841660068110610d6f57610d6f61439d565b0154610d7b9190614283565b610d85919061411e565b610d8f90836140de565b91505b80610d9c81614300565b915050610c02565b508415610db15760145560005b600086815260186020526040902060170154610dce9083906142a2565b610dd890826140de565b905060006028610de9836019614283565b610df3919061411e565b90506000610e0182846142a2565b6004546040519192506001600160a01b03169083156108fc029084906000818181858888f19350505050158015610e3c573d6000803e3d6000fd5b506005546001600160a01b03166108fc6105dc610e5a846064614283565b610e64919061411e565b6040518115909202916000818181858888f19350505050158015610e8c573d6000803e3d6000fd5b506006546001600160a01b03166108fc6105dc610eaa846064614283565b610eb4919061411e565b6040518115909202916000818181858888f19350505050158015610edc573d6000803e3d6000fd5b506007546001600160a01b03166108fc6105dc610efa846064614283565b610f04919061411e565b6040518115909202916000818181858888f19350505050158015610f2c573d6000803e3d6000fd5b506008546001600160a01b03166108fc6105dc610f4b846101f4614283565b610f55919061411e565b6040518115909202916000818181858888f19350505050158015610f7d573d6000803e3d6000fd5b506009546001600160a01b03166108fc6105dc610f9c846101f4614283565b610fa6919061411e565b6040518115909202916000818181858888f19350505050158015610fce573d6000803e3d6000fd5b50600a546001600160a01b03166108fc6105dc610fec846019614283565b610ff6919061411e565b6040518115909202916000818181858888f1935050505015801561101e573d6000803e3d6000fd5b50600b546001600160a01b03166108fc6105dc61103c846019614283565b611046919061411e565b6040518115909202916000818181858888f1935050505015801561106e573d6000803e3d6000fd5b50600c546001600160a01b03166108fc6105dc61108c846019614283565b611096919061411e565b6040518115909202916000818181858888f193505050501580156110be573d6000803e3d6000fd5b50600d546001600160a01b03166108fc6105dc6110dc846019614283565b6110e6919061411e565b6040518115909202916000818181858888f1935050505015801561110e573d6000803e3d6000fd5b50600e546001600160a01b03166108fc6105dc61112c846019614283565b611136919061411e565b6040518115909202916000818181858888f1935050505015801561115e573d6000803e3d6000fd5b50600f546001600160a01b03166108fc6105dc61117c84604b614283565b611186919061411e565b6040518115909202916000818181858888f193505050501580156111ae573d6000803e3d6000fd5b506010547fe74afa23516e96de1c300819636c73e7f9a4b567b4ced7461d65e5c962231682601860008b81526020019081526020016000206018016040516111f69190614084565b60405180910390a250506001600055505050505050565b6001600160a01b0384166000908152601c602090815260408083208684529091528120546060918291829190859061124588826142a2565b8211156112595761125688826142a2565b91505b60008267ffffffffffffffff811115611274576112746143b3565b60405190808252806020026020018201604052801561129d578160200160208202803683370190505b50905060008367ffffffffffffffff8111156112bb576112bb6143b3565b6040519080825280602002602001820160405280156112f457816020015b6112e16138b8565b8152602001906001900390816112d95790505b50905060008467ffffffffffffffff811115611312576113126143b3565b60405190808252806020026020018201604052801561133b578160200160208202803683370190505b50905060005b858110156114f857601c60008f6001600160a01b03166001600160a01b0316815260200190815260200160002060008e81526020019081526020016000208c8261138b91906140de565b8154811061139b5761139b61439d565b90600052602060002001548482815181106113b8576113b861439d565b602002602001018181525050601960008583815181106113da576113da61439d565b6020908102919091018101518252818101929092526040908101600020815160e08101928390529290918391820190839060069082845b8154815260200190600101908083116114115750505050508152505083828151811061143f5761143f61439d565b602002602001018190525060006001600160a01b03166019600086848151811061146b5761146b61439d565b6020908102919091018101518252810191909152604001600020600601546001600160a01b031614156114c15760018282815181106114ac576114ac61439d565b911515602092830291909101909101526114e6565b60008282815181106114d5576114d561439d565b911515602092830291909101909101525b806114f0816142e5565b915050611341565b50828282611506888f6140de565b98509850985098505050505050945094509450949050565b6000600360008481526018602052604090205460ff16600381111561154557611545614387565b146115525750600061159d565b6000838152601860205260409020601601548211801561158357506000838152601860205260409020601501548211155b156115905750600061159d565b61159a83836134ef565b90505b92915050565b6115ab6138d0565b60008281526018602052604090819020815161014081019092528054829060ff1660038111156115dd576115dd614387565b60038111156115ee576115ee614387565b8152600182015460208201526002820154604080830191909152805160c081019182905260609092019190600384019060069082845b8154815260200190600101908083116116245750505091835250506040805160c081019182905260209092019190600984019060069082845b81548152602001906001019080831161165d5750505091835250506040805160c081019182905260209092019190600f84019060069082845b8154815260200190600101908083116116965750505091835250506015820154602080830191909152601683015460408084019190915260178401546060840152805160e08101918290526080909301929160188501918391820190839060069082845b8154815260200190600101908083116116fa575050509190925250505090525092915050565b6001546001600160a01b0316331461174a5760405162461bcd60e51b815260040161074e90613f59565b6015546001600160a01b03838116911614156117a85760405162461bcd60e51b815260206004820152601760248201527f43616e6e6f742062652041657465726e6120746f6b656e000000000000000000604482015260640161074e565b6117bc6001600160a01b03831633836135d7565b604080516001600160a01b0384168152602081018390527f74545154aac348a3eac92596bd1971957ca94795f4e954ec5f613b55fab78129910160405180910390a15050565b333b156118485760405162461bcd60e51b815260206004820152601460248201527310dbdb9d1c9858dd081b9bdd08185b1b1bddd95960621b604482015260640161074e565b3332146118975760405162461bcd60e51b815260206004820152601a60248201527f50726f787920636f6e7472616374206e6f7420616c6c6f776564000000000000604482015260640161074e565b600260005414156118ba5760405162461bcd60e51b815260040161074e90613f8e565b60026000908155662386f26fc100006015546040516370a0823160e01b81523360048201529192506000916001600160a01b03909116906370a082319060240160206040518083038186803b15801561191257600080fd5b505afa158015611926573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061194a9190613be7565b90508261198f5760405162461bcd60e51b8152602060048201526013602482015272139bc81d1a58dad95d081cdc1958da599a5959606a1b604482015260640161074e565b80156119f35761199f8284614283565b3410156119ee5760405162461bcd60e51b815260206004820152601f60248201527f496e73756666696369656e742066756e647320666f72207469636b6574732e00604482015260640161074e565b611a58565b816119ff846002614283565b611a099190614283565b341015611a585760405162461bcd60e51b815260206004820152601f60248201527f496e73756666696369656e742066756e647320666f72207469636b6574732e00604482015260640161074e565b600160008681526018602052604090205460ff166003811115611a7d57611a7d614387565b14611ac05760405162461bcd60e51b81526020600482015260136024820152722637ba3a32b93c9034b9903737ba1037b832b760691b604482015260640161074e565b6000858152601860205260409020600201544210611b125760405162461bcd60e51b815260206004820152600f60248201526e2637ba3a32b93c9034b99037bb32b960891b604482015260640161074e565b60008581526018602052604081206017018054349290611b339084906140de565b90915550600090505b83811015611c6b576000858583818110611b5857611b5861439d565b905060c00201803603810190611b6e9190613bb2565b9050611b79816131c7565b611bb55760405162461bcd60e51b815260206004820152600d60248201526c4f7574736964652072616e676560981b604482015260640161074e565b336000818152601c602090815260408083208b8452825280832060118054825460018101845592865284862090920191909155815180830183528681528084019590955254835260199091529020815180518290611c16908290600661387a565b50505060209190910151600690910180546001600160a01b0319166001600160a01b0390921691909117905560118054906000611c52836142e5565b9190505550508080611c63906142e5565b915050611b3c565b503360009081526013602052604090205460ff16611cb157336000908152601360205260408120805460ff191660011790556012805491611cab836142e5565b91905055505b604051838152859033907fd7d247b583de1023852eef87b48f54354dbec771d01bc2cc49e96094efc322b99060200160405180910390a350506001600055505050565b6001546001600160a01b03163314611d1e5760405162461bcd60e51b815260040161074e90613f59565b6001546040516000916001600160a01b0316907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0908390a3600180546001600160a01b0319169055565b6060808260008167ffffffffffffffff811115611d8757611d876143b3565b604051908082528060200260200182016040528015611dc057816020015b611dad6138b8565b815260200190600190039081611da55790505b50905060008267ffffffffffffffff811115611dde57611dde6143b3565b604051908082528060200260200182016040528015611e07578160200160208202803683370190505b50905060005b83811015611f3d5760196000898984818110611e2b57611e2b61439d565b60209081029290920135835250818101929092526040908101600020815160e08101928390529290918391820190839060069082845b815481526020019060010190808311611e6157505050505081525050838281518110611e8f57611e8f61439d565b602090810291909101015260006019818a8a85818110611eb157611eb161439d565b60209081029290920135835250810191909152604001600020600601546001600160a01b03161415611f06576001828281518110611ef157611ef161439d565b91151560209283029190910190910152611f2b565b6000828281518110611f1a57611f1a61439d565b911515602092830291909101909101525b80611f35816142e5565b915050611e0d565b509093509150505b9250929050565b6001546001600160a01b03163314611f765760405162461bcd60e51b815260040161074e90613f59565b600360105460009081526018602052604090205460ff166003811115611f9e57611f9e614387565b14611feb5760405162461bcd60e51b815260206004820152601860248201527f4c6f7474657279206e6f7420696e20636c61696d61626c650000000000000000604482015260640161074e565b806001600160a01b031663b37217a460105460115460405160200161201a929190918252602082015260400190565b60408051808303601f1901815290829052805160209091012060e083901b6001600160e01b03191682526004820152602401600060405180830381600087803b15801561206657600080fd5b505af115801561207a573d6000803e3d6000fd5b50505050806001600160a01b031663a1c4f55a6040518163ffffffff1660e01b815260040160206040518083038186803b1580156120b757600080fd5b505afa1580156120cb573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906120ef9190613d40565b50601680546001600160a01b0319166001600160a01b0383169081179091556040517f383f8cb39dfa7c3fb901a460dd449ea924868f0a92ff03da64740fffa5f1de6290600090a250565b6003546001600160a01b031633146121645760405162461bcd60e51b815260040161074e90613fc5565b600260005414156121875760405162461bcd60e51b815260040161074e90613f8e565b6002600055600160008281526018602052604090205460ff1660038111156121b1576121b1614387565b146121f15760405162461bcd60e51b815260206004820152601060248201526f2637ba3a32b93c903737ba1037b832b760811b604482015260640161074e565b60008181526018602052604090206002015442116122445760405162461bcd60e51b815260206004820152601060248201526f2637ba3a32b93c903737ba1037bb32b960811b604482015260640161074e565b6011546000828152601860209081526040918290206016908101849055548251918201859052918101929092526001600160a01b03169063b37217a49060600160408051808303601f1901815290829052805160209091012060e083901b6001600160e01b03191682526004820152602401600060405180830381600087803b1580156122d057600080fd5b505af11580156122e4573d6000803e3d6000fd5b505050600082815260186020908152604091829020805460ff1916600217905560115491519182528392507f3728e75294796694d59d2ffced9c394279baf7b9ebd2702db43f5f04bac67929910160405180910390a2506001600055565b6001546001600160a01b0316331461236c5760405162461bcd60e51b815260040161074e90613f59565b6001600160a01b0385166123925760405162461bcd60e51b815260040161074e90613f29565b6001600160a01b0384166123b85760405162461bcd60e51b815260040161074e90613f29565b6001600160a01b0383166123de5760405162461bcd60e51b815260040161074e90613f29565b60005b600b81101561244c5760008383838181106123fe576123fe61439d565b90506020020160208101906124139190613a5f565b6001600160a01b0316141561243a5760405162461bcd60e51b815260040161074e90613f29565b80612444816142e5565b9150506123e1565b50600380546001600160a01b038088166001600160a01b031992831617909255600480548784169083161790556002805492861692909116919091179055818160008161249b5761249b61439d565b90506020020160208101906124b09190613a5f565b600580546001600160a01b0319166001600160a01b0392909216919091179055818160018181106124e3576124e361439d565b90506020020160208101906124f89190613a5f565b600680546001600160a01b0319166001600160a01b03929092169190911790558181600281811061252b5761252b61439d565b90506020020160208101906125409190613a5f565b600780546001600160a01b0319166001600160a01b0392909216919091179055818160038181106125735761257361439d565b90506020020160208101906125889190613a5f565b600880546001600160a01b0319166001600160a01b0392909216919091179055818160048181106125bb576125bb61439d565b90506020020160208101906125d09190613a5f565b600980546001600160a01b0319166001600160a01b0392909216919091179055818160058181106126035761260361439d565b90506020020160208101906126189190613a5f565b600a80546001600160a01b0319166001600160a01b03929092169190911790558181600681811061264b5761264b61439d565b90506020020160208101906126609190613a5f565b600b80546001600160a01b0319166001600160a01b0392909216919091179055818160078181106126935761269361439d565b90506020020160208101906126a89190613a5f565b600c80546001600160a01b0319166001600160a01b0392909216919091179055818160088181106126db576126db61439d565b90506020020160208101906126f09190613a5f565b600d80546001600160a01b0319166001600160a01b0392909216919091179055818160098181106127235761272361439d565b90506020020160208101906127389190613a5f565b600e80546001600160a01b0319166001600160a01b03929092169190911790558181600a81811061276b5761276b61439d565b90506020020160208101906127809190613a5f565b600f80546001600160a01b0319166001600160a01b039283161790556040805187831681528683166020820152918516908201527f3e945b7660001d46cfd5e729545f7f0b6c65bdee54066a91c7acad703f1b731e9060600160405180910390a15050505050565b6003546001600160a01b031633146128125760405162461bcd60e51b815260040161074e90613fc5565b61281a613936565b6000808252602082018190526040820152606460608201526103e860808201526122c460a082015260105415806128765750600360105460009081526018602052604090205460ff16600381111561287457612874614387565b145b6128c25760405162461bcd60e51b815260206004820152601960248201527f4e6f742074696d6520746f207374617274206c6f747465727900000000000000604482015260640161074e565b6137146128cf42846142a2565b1180156128e757506205472c6128e542846142a2565b105b6129335760405162461bcd60e51b815260206004820152601f60248201527f4c6f7474657279206c656e677468206f757473696465206f662072616e676500604482015260640161074e565b60a08101516080820151606083015160408401516020850151855161295891906140de565b61296291906140de565b61296c91906140de565b61297691906140de565b61298091906140de565b612710146129d05760405162461bcd60e51b815260206004820152601860248201527f52657761726473206d75737420657175616c2031303030300000000000000000604482015260640161074e565b601080549060006129e0836142e5565b909155505060408051610140810190915280600181526020014281526020018381526020018281526020016040518060c001604052806000815260200160008152602001600081526020016000815260200160008152602001600081525081526020016040518060c0016040528060008152602001600081526020016000815260200160008152602001600081526020016000815250815260200160115481526020016011548152602001601454815260200160405180602001604052806040518060c001604052806000815260200160008152602001600081526020016000815260200160008152602001600081525081525081525060186000601054815260200190815260200160002060008201518160000160006101000a81548160ff02191690836003811115612b1657612b16614387565b021790555060208201516001820155604082015160028201556060820151612b44906003830190600661387a565b506080820151612b5a906009830190600661387a565b5060a0820151612b7090600f830190600661387a565b5060c0820151601582015560e08201516016820155610100820151601782015561012082015180516018830190612baa908290600661387a565b505060105460115460145460408051428152602081018a90529081019290925260608201529093507fd334851c83074cc65278baf7a2f3222bb4e342f0160b194b132083767984ba659250608001905060405180910390a250506000601455565b6001546001600160a01b0316331480612c2e57506002546001600160a01b031633145b612c725760405162461bcd60e51b81526020600482015260156024820152742737ba1037bbb732b91037b91034b73532b1ba37b960591b604482015260640161074e565b600160008281526018602052604090205460ff166003811115612c9757612c97614387565b14612cd75760405162461bcd60e51b815260206004820152601060248201526f2637ba3a32b93c903737ba1037b832b760811b604482015260640161074e565b60008181526018602052604081206017018054349290612cf89084906140de565b909155505060405134815281907f1bbd659dd628a25f7ff2eabb69c74a56939c539728282275c1c9c1a2d3e340499060200160405180910390a250565b333b15612d7b5760405162461bcd60e51b815260206004820152601460248201527310dbdb9d1c9858dd081b9bdd08185b1b1bddd95960621b604482015260640161074e565b333214612dca5760405162461bcd60e51b815260206004820152601a60248201527f50726f787920636f6e7472616374206e6f7420616c6c6f776564000000000000604482015260640161074e565b60026000541415612ded5760405162461bcd60e51b815260040161074e90613f8e565b600260005580612e335760405162461bcd60e51b815260206004820152601160248201527004c656e677468206d757374206265203e3607c1b604482015260640161074e565b600360008481526018602052604090205460ff166003811115612e5857612e58614387565b14612e9d5760405162461bcd60e51b81526020600482015260156024820152744c6f7474657279206e6f7420636c61696d61626c6560581b604482015260640161074e565b6000805b82811015613065576000848483818110612ebd57612ebd61439d565b90506020020135905080601860008881526020019081526020016000206016015411612f1f5760405162461bcd60e51b81526020600482015260116024820152700a8d2c6d6cae892c840e8dede40d0d2ced607b1b604482015260640161074e565b600086815260186020526040902060150154811015612f735760405162461bcd60e51b815260206004820152601060248201526f5469636b6574496420746f6f206c6f7760801b604482015260640161074e565b6000818152601960205260409020600601546001600160a01b03163314612fcc5760405162461bcd60e51b815260206004820152600d60248201526c2737ba103a34329037bbb732b960991b604482015260640161074e565b600081815260196020526040812060060180546001600160a01b0319169055612ff587836134ef565b9050806130445760405162461bcd60e51b815260206004820152601860248201527f4e6f207072697a6520666f722074686973207469636b65740000000000000000604482015260640161074e565b61304e81856140de565b93505050808061305d906142e5565b915050612ea1565b50604051339082156108fc029083906000818181858888f19350505050158015613093573d6000803e3d6000fd5b506040805182815260208101849052859133917f0f5fca62da8fb5d95525b49e5eaa7b20bc6bd9e2f6b64b493442d1c0bd6ef486910160405180910390a3505060016000555050565b6001546001600160a01b031633146131065760405162461bcd60e51b815260040161074e90613f59565b6001600160a01b03811661316b5760405162461bcd60e51b815260206004820152602660248201527f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160448201526564647265737360d01b606482015260840161074e565b6001546040516001600160a01b038084169216907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e090600090a3600180546001600160a01b0319166001600160a01b0392909216919091179055565b6000805b600681101561329857825160009082600681106131ea576131ea61439d565b602002015111801561321557508251604190826006811061320d5761320d61439d565b602002015111155b1561327d5760005b8181101561327757835181600681106132385761323861439d565b6020020151845183600681106132505761325061439d565b60200201511415613265575060009392505050565b8061326f816142e5565b91505061321d565b50613286565b50600092915050565b80613290816142e5565b9150506131cb565b50600192915050565b6132a96138b8565b8151516000908152601a60205260409020805460ff1916600190811790915582905b60068110156133f757601a6000836000015183600681106132ee576132ee61439d565b6020908102919091015182528101919091526040016000205460ff161561339e57815160009082600681106133255761332561439d565b602002015190505b6000818152601a602052604090205460ff16156133825760416133518260016140de565b61335c8360016140de565b6133669190614283565b6133709190614324565b61337b9060016140de565b905061332d565b8251819083600681106133975761339761439d565b6020020152505b6001601a6000846000015184600681106133ba576133ba61439d565b6020020151815260200190815260200160002060006101000a81548160ff02191690831515021790555080806133ef906142e5565b9150506132cb565b5060005b600681101561345d576000601a6000846000015184600681106134205761342061439d565b6020020151815260200190815260200160002060006101000a81548160ff0219169083151502179055508080613455906142e5565b9150506133fb565b5092915050565b600080805b60068110156134e75760005b60068110156134d457845181600681106134915761349161439d565b6020020151865183600681106134a9576134a961439d565b602002015114156134c257826134be816142e5565b9350505b806134cc816142e5565b915050613475565b50806134df816142e5565b915050613469565b509392505050565b6000828152601860208181526040808420815160e08101909252849361358d93910190829081018260068282826020028201915b8154815260200190600101908083116135235750505091909252505050600085815260196020908152604091829020825160e081019093529082908101826006828282602002820191815481526020019060010190808311610b8157505050505081525050613464565b9050600481106135cd5760008481526018602052604090206009016135b36001836142a2565b600681106135c3576135c361439d565b015491505061159d565b600091505061159d565b604080516001600160a01b038416602482015260448082018490528251808303909101815260649091019091526020810180516001600160e01b031663a9059cbb60e01b17905261362990849061362e565b505050565b6000613683826040518060400160405280602081526020017f5361666545524332303a206c6f772d6c6576656c2063616c6c206661696c6564815250856001600160a01b03166137009092919063ffffffff16565b80519091501561362957808060200190518101906136a19190613b95565b6136295760405162461bcd60e51b815260206004820152602a60248201527f5361666545524332303a204552433230206f7065726174696f6e20646964206e6044820152691bdd081cdd58d8d9595960b21b606482015260840161074e565b606061370f8484600085613719565b90505b9392505050565b60608247101561377a5760405162461bcd60e51b815260206004820152602660248201527f416464726573733a20696e73756666696369656e742062616c616e636520666f6044820152651c8818d85b1b60d21b606482015260840161074e565b843b6137c85760405162461bcd60e51b815260206004820152601d60248201527f416464726573733a2063616c6c20746f206e6f6e2d636f6e7472616374000000604482015260640161074e565b600080866001600160a01b031685876040516137e49190613e38565b60006040518083038185875af1925050503d8060008114613821576040519150601f19603f3d011682016040523d82523d6000602084013e613826565b606091505b5091509150613836828286613841565b979650505050505050565b60608315613850575081613712565b8251156138605782518084602001fd5b8160405162461bcd60e51b815260040161074e9190613ef6565b82600681019282156138a8579160200282015b828111156138a857825182559160200191906001019061388d565b506138b4929150613954565b5090565b60405180602001604052806138cb613936565b905290565b604080516101408101909152806000815260200160008152602001600081526020016138fa613936565b8152602001613907613936565b8152602001613914613936565b81526020016000815260200160008152602001600081526020016138cb6138b8565b6040518060c001604052806006906020820280368337509192915050565b5b808211156138b45760008155600101613955565b80356001600160a01b038116811461398057600080fd5b919050565b60008083601f84011261399757600080fd5b50813567ffffffffffffffff8111156139af57600080fd5b6020830191508360208260051b8501011115611f4557600080fd5b600060c082840312156139dc57600080fd5b604051602080820182811067ffffffffffffffff82111715613a0057613a006143b3565b806040525081925084601f850112613a1757600080fd5b613a1f6140b5565b80858760c088011115613a3157600080fd5b60005b6006811015613a5157813584529284019290840190600101613a34565b505090925250909392505050565b600060208284031215613a7157600080fd5b61159a82613969565b600080600080600060808688031215613a9257600080fd5b613a9b86613969565b9450613aa960208701613969565b9350613ab760408701613969565b9250606086013567ffffffffffffffff811115613ad357600080fd5b613adf88828901613985565b969995985093965092949392505050565b60008060408385031215613b0357600080fd5b613b0c83613969565b946020939093013593505050565b60008060008060808587031215613b3057600080fd5b613b3985613969565b966020860135965060408601359560600135945092505050565b60008060208385031215613b6657600080fd5b823567ffffffffffffffff811115613b7d57600080fd5b613b8985828601613985565b90969095509350505050565b600060208284031215613ba757600080fd5b8151613712816143c9565b600060c08284031215613bc457600080fd5b61159a83836139ca565b600060208284031215613be057600080fd5b5035919050565b600060208284031215613bf957600080fd5b5051919050565b600080600060408486031215613c1557600080fd5b83359250602084013567ffffffffffffffff80821115613c3457600080fd5b818601915086601f830112613c4857600080fd5b813581811115613c5757600080fd5b87602060c083028501011115613c6c57600080fd5b6020830194508093505050509250925092565b600080600060408486031215613c9457600080fd5b83359250602084013567ffffffffffffffff811115613cb257600080fd5b613cbe86828701613985565b9497909650939450505050565b6000806000806101208587031215613ce257600080fd5b843593506020850135613cf4816143c9565b92506040850135613d04816143c9565b9150613d1386606087016139ca565b905092959194509250565b60008060408385031215613d3157600080fd5b50508035926020909101359150565b600060208284031215613d5257600080fd5b815163ffffffff8116811461371257600080fd5b600081518084526020808501945080840160005b83811015613d98578151151587529582019590820190600101613d7a565b509495945050505050565b600081518084526020808501945080840160005b83811015613d9857613dcb87835151613dde565b60c0969096019590820190600101613db7565b8060005b6006811015613e01578151845260209384019390910190600101613de2565b50505050565b60048110613e2557634e487b7160e01b600052602160045260246000fd5b9052565b613e34828251613dde565b5050565b60008251613e4a8184602087016142b9565b9190910192915050565b604081526000613e676040830185613da3565b8281036020840152613e798185613d66565b95945050505050565b6080808252855190820181905260009060209060a0840190828901845b82811015613ebb57815184529284019290840190600101613e9f565b50505083810382850152613ecf8188613da3565b9150508281036040840152613ee48186613d66565b91505082606083015295945050505050565b6020815260008251806020840152613f158160408501602087016142b9565b601f01601f19169190910160400192915050565b60208082526016908201527543616e6e6f74206265207a65726f206164647265737360501b604082015260600190565b6020808252818101527f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e6572604082015260600190565b6020808252601f908201527f5265656e7472616e637947756172643a207265656e7472616e742063616c6c00604082015260600190565b6020808252600c908201526b2737ba1037b832b930ba37b960a11b604082015260600190565b60006103c082019050613fff828451613e07565b602083015160208301526040830151604083015260608301516140256060840182613dde565b50608083015161012061403a81850183613dde565b60a0850151915061404f6101e0850183613dde565b60c08501516102a085015260e08501516102c08501526101008501516102e0850152840151905061345d610300840182613e29565b60c08101818360005b60068110156140ac57815483526020909201916001918201910161408d565b50505092915050565b60405160c0810167ffffffffffffffff811182821017156140d8576140d86143b3565b60405290565b600082198211156140f1576140f161435b565b500190565b600063ffffffff8083168185168083038211156141155761411561435b565b01949350505050565b60008261412d5761412d614371565b500490565b600063ffffffff8084168061414957614149614371565b92169190910492915050565b600181815b80851115614192578163ffffffff048211156141785761417861435b565b8085161561418557918102915b93841c939080029061415a565b509250929050565b600063ffffffff6141af8185168285166141b7565b949350505050565b6000826141c65750600161159d565b816141d35750600061159d565b81600181146141e957600281146141f357614224565b600191505061159d565b60ff8411156142045761420461435b565b6001841b915063ffffffff82111561421e5761421e61435b565b5061159d565b5060208310610133831016604e8410600b841016171561425b575081810a63ffffffff8111156142565761425661435b565b61159d565b6142658383614155565b8063ffffffff0482111561427b5761427b61435b565b029392505050565b600081600019048311821515161561429d5761429d61435b565b500290565b6000828210156142b4576142b461435b565b500390565b60005b838110156142d45781810151838201526020016142bc565b83811115613e015750506000910152565b60006000198214156142f9576142f961435b565b5060010190565b600063ffffffff8083168181141561431a5761431a61435b565b6001019392505050565b60008261433357614333614371565b500690565b600063ffffffff8084168061434f5761434f614371565b92169190910692915050565b634e487b7160e01b600052601160045260246000fd5b634e487b7160e01b600052601260045260246000fd5b634e487b7160e01b600052602160045260246000fd5b634e487b7160e01b600052603260045260246000fd5b634e487b7160e01b600052604160045260246000fd5b80151581146143d757600080fd5b5056fea264697066735822122081e11f8f5466a22a1e40629d00af8ad98f13bc6b218e871776bcb89a2c1bd16c64736f6c634300080700330000000000000000000000001753c1a29ff90ac6c52f46c23c6fda94d34a70eb00000000000000000000000031de192fff4207eddbb9225be5fac5868aa01da4';
    let deploy_contract = new web3Data.web3.eth.Contract(abi);
    let account = web3Data.address;
    let payload = {
      data: bytecode,
      arguments: [
        "0x1753C1a29Ff90ac6C52F46C23C6FDA94d34a70Eb",
        RNGInstance.options.address
      ]
    }
    let parameter = {
      from: account,
      // gas: web3Data.web3.utils.toHex(800000),
      // gasPrice: web3Data.web3.utils.toHex(web3Data.web3.utils.toWei('30', 'gwei'))
    }
    console.log(parameter);
    deploy_contract.deploy(payload).send(parameter, (err, transactionHash) => {
      console.log('Transaction Hash :', transactionHash);
    }).on('confirmation', () => { }).then((newContractInstance) => {
      console.log('Deployed Contract Address : ', newContractInstance.options.address);
      setLotteryInstance(newContractInstance);
      setButtonIndex(4);
    })
  }

  const setFee = async () => {
    let account = web3Data.address;
    let parameter = {
      from: account,
      // gas: web3Data.web3.utils.toHex(800000),
      // gasPrice: web3Data.web3.utils.toHex(web3Data.web3.utils.toWei('30', 'gwei'))
    }
    RNGInstance.methods.setFee("100000000000000000").send(parameter, (err, transactionHash) => {
      console.log('Transaction Hash :', transactionHash);
    }).on('confirmation', () => { }).then((contractInstance) => {
      setButtonIndex(2);
    })
  }

  const setKeyHash = async () => {
    let account = web3Data.address;
    let parameter = {
      from: account,
      // gas: web3Data.web3.utils.toHex(800000),
      // gasPrice: web3Data.web3.utils.toHex(web3Data.web3.utils.toWei('30', 'gwei'))
    }
    RNGInstance.methods.setKeyHash("0xcaf3c3727e033261d383b315559476f48034c13b18f8cafed4d871abe5049186").send(parameter, (err, transactionHash) => {
      console.log('Transaction Hash :', transactionHash);
    }).on('confirmation', () => { }).then((contractInstance) => {
      setButtonIndex(3);
    })
  }

  const deploy = async () => {
    let RNG_bytecode = '60c060405234801561001057600080fd5b50604051610f5e380380610f5e83398101604081905261002f916100c3565b6001600160601b0319606083811b821660a05282901b1660805260006100523390565b600180546001600160a01b0319166001600160a01b038316908117909155604051919250906000907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0908290a35050506100f6565b80516001600160a01b03811681146100be57600080fd5b919050565b600080604083850312156100d657600080fd5b6100df836100a7565b91506100ed602084016100a7565b90509250929050565b60805160601c60a05160601c610e2f61012f6000396000818161039201526108490152600081816104f9015261081a0152610e2f6000f3fe608060405234801561001057600080fd5b506004361061010b5760003560e01c80638da5cb5b116100a2578063b37217a411610071578063b37217a41461020d578063ddca3f4314610220578063eed8e1ee14610229578063f2fde38b14610232578063fbe5d9171461024557600080fd5b80638da5cb5b146101c857806394985ddd146101d957806398544710146101ec578063a1c4f55a146101ff57600080fd5b80634bf3057d116100de5780634bf3057d1461017957806361728f39146101a457806369fe0e2d146101ad578063715018a6146101c057600080fd5b806306b091f9146101105780631aa46f59146101255780632a332b2a1461014157806342619f6614610154575b600080fd5b61012361011e366004610c21565b61024d565b005b61012e60045481565b6040519081526020015b60405180910390f35b61012361014f366004610c06565b610298565b6005546101649063ffffffff1681565b60405163ffffffff9091168152602001610138565b60025461018c906001600160a01b031681565b6040516001600160a01b039091168152602001610138565b61012e60035481565b6101236101bb366004610c6d565b6102e4565b610123610313565b6001546001600160a01b031661018c565b6101236101e7366004610c86565b610387565b6101236101fa366004610c6d565b610409565b60055463ffffffff16610164565b61012361021b366004610c6d565b610438565b61012e60065481565b61012e60075481565b610123610240366004610c06565b6105d7565b60075461012e565b6001546001600160a01b031633146102805760405162461bcd60e51b815260040161027790610d4c565b60405180910390fd5b6102946001600160a01b03831633836106c2565b5050565b6001546001600160a01b031633146102c25760405162461bcd60e51b815260040161027790610d4c565b600280546001600160a01b0319166001600160a01b0392909216919091179055565b6001546001600160a01b0316331461030e5760405162461bcd60e51b815260040161027790610d4c565b600655565b6001546001600160a01b0316331461033d5760405162461bcd60e51b815260040161027790610d4c565b6001546040516000916001600160a01b0316907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0908390a3600180546001600160a01b0319169055565b336001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016146103ff5760405162461bcd60e51b815260206004820152601f60248201527f4f6e6c7920565246436f6f7264696e61746f722063616e2066756c66696c6c006044820152606401610277565b6102948282610719565b6001546001600160a01b031633146104335760405162461bcd60e51b815260040161027790610d4c565b600355565b6002546001600160a01b031633146104925760405162461bcd60e51b815260206004820152601760248201527f4f6e6c792050616e63616b65537761704c6f74746572790000000000000000006044820152606401610277565b6003546104e15760405162461bcd60e51b815260206004820152601860248201527f4d75737420686176652076616c6964206b6579206861736800000000000000006044820152606401610277565b6006546040516370a0823160e01b81523060048201527f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316906370a082319060240160206040518083038186803b15801561054357600080fd5b505afa158015610557573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061057b9190610ca8565b10156105c25760405162461bcd60e51b81526020600482015260166024820152754e6f7420656e6f756768204c494e4b20746f6b656e7360501b6044820152606401610277565b6105d160035460065483610816565b60045550565b6001546001600160a01b031633146106015760405162461bcd60e51b815260040161027790610d4c565b6001600160a01b0381166106665760405162461bcd60e51b815260206004820152602660248201527f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160448201526564647265737360d01b6064820152608401610277565b6001546040516001600160a01b038084169216907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e090600090a3600180546001600160a01b0319166001600160a01b0392909216919091179055565b604080516001600160a01b038416602482015260448082018490528251808303909101815260649091019091526020810180516001600160e01b031663a9059cbb60e01b1790526107149084906109a0565b505050565b816004541461075c5760405162461bcd60e51b815260206004820152600f60248201526e15dc9bdb99c81c995c5d595cdd1259608a1b6044820152606401610277565b610769620f424082610dd7565b61077690620f4240610d81565b6005805463ffffffff191663ffffffff9290921691909117905560025460408051630405030b60e51b815290516001600160a01b03909216916380a06160916004808201926020929091908290030181600087803b1580156107d757600080fd5b505af11580156107eb573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061080f9190610ca8565b6007555050565b60007f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316634000aea07f0000000000000000000000000000000000000000000000000000000000000000858786604051602001610885929190918252602082015260400190565b6040516020818303038152906040526040518463ffffffff1660e01b81526004016108b293929190610d09565b602060405180830381600087803b1580156108cc57600080fd5b505af11580156108e0573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906109049190610c4b565b5060008481526020818152604080832054815180840189905280830187905230606082015260808082018390528351808303909101815260a09091019092528151918301919091208784529290915261095e906001610d81565b600086815260208181526040918290209290925580518083018890528082019390935280518084038201815260609093019052815191012090505b9392505050565b60006109f5826040518060400160405280602081526020017f5361666545524332303a206c6f772d6c6576656c2063616c6c206661696c6564815250856001600160a01b0316610a729092919063ffffffff16565b8051909150156107145780806020019051810190610a139190610c4b565b6107145760405162461bcd60e51b815260206004820152602a60248201527f5361666545524332303a204552433230206f7065726174696f6e20646964206e6044820152691bdd081cdd58d8d9595960b21b6064820152608401610277565b6060610a818484600085610a89565b949350505050565b606082471015610aea5760405162461bcd60e51b815260206004820152602660248201527f416464726573733a20696e73756666696369656e742062616c616e636520666f6044820152651c8818d85b1b60d21b6064820152608401610277565b843b610b385760405162461bcd60e51b815260206004820152601d60248201527f416464726573733a2063616c6c20746f206e6f6e2d636f6e74726163740000006044820152606401610277565b600080866001600160a01b03168587604051610b549190610ced565b60006040518083038185875af1925050503d8060008114610b91576040519150601f19603f3d011682016040523d82523d6000602084013e610b96565b606091505b5091509150610ba6828286610bb1565b979650505050505050565b60608315610bc0575081610999565b825115610bd05782518084602001fd5b8160405162461bcd60e51b81526004016102779190610d39565b80356001600160a01b0381168114610c0157600080fd5b919050565b600060208284031215610c1857600080fd5b61099982610bea565b60008060408385031215610c3457600080fd5b610c3d83610bea565b946020939093013593505050565b600060208284031215610c5d57600080fd5b8151801515811461099957600080fd5b600060208284031215610c7f57600080fd5b5035919050565b60008060408385031215610c9957600080fd5b50508035926020909101359150565b600060208284031215610cba57600080fd5b5051919050565b60008151808452610cd9816020860160208601610da7565b601f01601f19169290920160200192915050565b60008251610cff818460208701610da7565b9190910192915050565b60018060a01b0384168152826020820152606060408201526000610d306060830184610cc1565b95945050505050565b6020815260006109996020830184610cc1565b6020808252818101527f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e6572604082015260600190565b60008219821115610da257634e487b7160e01b600052601160045260246000fd5b500190565b60005b83811015610dc2578181015183820152602001610daa565b83811115610dd1576000848401525b50505050565b600082610df457634e487b7160e01b600052601260045260246000fd5b50069056fea26469706673582212200aa3309d5e0e7856ae7106c1bcf9fa9ce786a32f83ac6a3c049a8edf8634cfaf64736f6c634300080700330000000000000000000000006a2aad07396b36fe02a22b33cf443582f682c82f00000000000000000000000084b9b910527ad5c03a9ca831909e21e236ea7b06';
    let deploy_contract = new web3Data.web3.eth.Contract(RNG_abi);
    let account = web3Data.address;
    let payload = {
      data: RNG_bytecode,
      arguments: [
        "0xa555fC018435bef5A13C6c6870a9d4C11DEC329C",
        "0x84b9B910527Ad5C03A9Ca831909E21e236EA7b06"
      ]
    }
    let parameter = {
      from: account,
      // gas: web3Data.web3.utils.toHex(800000),
      // gasPrice: web3Data.web3.utils.toHex(web3Data.web3.utils.toWei('30', 'gwei'))
    }
    console.log(parameter);
    deploy_contract.deploy(payload).send(parameter, (err, transactionHash) => {
      console.log('Transaction Hash :', transactionHash);
    }).on('confirmation', () => { }).then((newContractInstance) => {
      console.log('Deployed Contract Address : ', newContractInstance.options.address);
      setRNGInstance(newContractInstance);
      setButtonIndex(1);
    })
  }

  const handleModalOpen = () => setModalOpen(true);
  const handleModalClose = () => setModalOpen(false);
  const handleSettingModalOpen = async (contractAddress) => {
    const { web3, provider, connected, address, chainId, networkId } = web3Data;
    setCurrentContractAddress(contractAddress);
    const contract = await getContractInstance(contractAddress);

    const curLotteryId = await contract.getCurrentLotteryId();
    const lotteryInfo = await contract.getLotteryInfo(curLotteryId);

    setWeb3Data({
      web3,
      provider,
      connected: true,
      address,
      chainId,
      networkId,
      contract,
      lotteryInfo
    });
    setTotalRound(curLotteryId);
    setLotteryIdForClose(curLotteryId);
    setLotteryIdForClaim(curLotteryId);
    setSettingModalOpen(true)
  };
  const handleSettingModalClose = () => setSettingModalOpen(false);

  const handleLotteryIdChange = (e) => {
    if (e.target.value >= 0) setLotteryIdForClose(e.target.value);
  };

  const handleWalletArray = (e) => {
    setWalletArray(e.target.value);
  }
  const handleChildNameChange = (e) => {
    setChildName(e.target.value);
  };
  const handleClaimableIdChange = (e) => {
    if (e.target.value >= 0) setLotteryIdForClaim(e.target.value);
  };
  const handleViewIdChange = (e) => {
    if (e.target.value >= 0) setLotteryIdForView(e.target.value);
  };
  const handleWinningNumberChange = (e) => {
    setWinningNumber(e.target.value);
  };

  const handlePrivKey = (e) => {
    setPrivKey(e.target.value);
  };
  const handleIntervalChange = (e) => {
    if (e.target.value >= 0)
      setInterval(e.target.value);
  };

  const handleAutoIntervalChange = (e) => {
    if (e.target.value >= 0)
      setAutoInterval(e.target.value);
  };

  const updateLotteryInfo = async () => {
    const lotteryInfo = await web3Data.contract.getLotteryInfo(lotteryIdForView);
    setLotteryInfo(lotteryInfo);
  }

  return (
    <div className="container mx-auto px-40 py-10">
      <div className="flex justify-between py-5">
        <div className="flex items-center">
          <img
            src={LogoImg}
            alt="logo"
            className="w-[40px] h-[40px] float-left"
          />
          <p className="font-bold px-4 text-4xl">Aeterna Lottery Admin Panel</p>
        </div>
        <div
          className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full w-48 text-center hover:cursor-pointer"
          onClick={web3Data.address === "" ? onConnect : resetApp}
        >
          {web3Data.address === "" ? "Connect Wallet" : ellipseAddress(web3Data.address, 5)}
        </div>
      </div>

      <div>
        {/* <h1 className="text-4xl text-red py-4">Mother-Child Lottery</h1> */}
        <div className="flex justify-between py-2 items-center">
          <Stack justifyContent="center" className="activity-table">
            <div className="activity-header font-bold flex justify-between">
              <span>Manage Lotteries</span>
              <Button
                variant="contained"
                className="text-white"
                style={{ margin: "10px", padding: "0 38px" }}
                onClick={() => handleModalOpen()}
              >
                Add
              </Button>
            </div>
            <TableContainer component={Paper}>
              <Table
                sx={{ minWidth: 650 }}
                aria-label="simple table"
                className="main-theme-color"
              >
                <TableHead>
                  <TableRow>
                    <TableCell className="text-white dashboard-overview-highlight" align="center">
                      Lottery Name
                    </TableCell>
                    <TableCell className="text-white dashboard-overview-highlight" align="center">
                      Contract Address
                    </TableCell>
                    <TableCell align="center" className="text-white dashboard-overview-highlight">
                    </TableCell>
                    <TableCell align="center" className="text-white dashboard-overview-highlight">
                    </TableCell>
                  </TableRow>
                </TableHead>
                <TableBody>
                  {web3Data ? (
                    web3Data.address !== "" ? (
                      childLists.length > 0 ? (
                        childLists.map((row, index) => (
                          <TableRow
                            key={index}
                            sx={{
                              "&:last-child td, &:last-child th": { border: 0 },
                            }}
                          >
                            <TableCell
                              align="center"
                              component="th"
                              scope="row"
                              className="text-white dashboard-overview-highlight"
                            >
                              {row.name}
                            </TableCell>
                            <TableCell
                              align="center"
                              component="th"
                              scope="row"
                              className="text-white dashboard-overview-highlight"
                            >
                              {row.address}
                            </TableCell>
                            <TableCell align="center" className="text-white dashboard-overview-highlight">
                              <Button
                                variant="outlined"
                                className="text-white"
                                style={{ border: "2px solid yellowgreen" }}
                                onClick={() => handleSettingModalOpen(row.address)}
                              >
                                Details
                              </Button>
                            </TableCell>
                            <TableCell align="center" className="text-white dashboard-overview-highlight">
                              <Button
                                variant="outlined"
                                className="text-white"
                                style={{ border: "2px solid yellowgreen" }}
                                onClick={() => window.confirm('Are you sure you wish to delete this item?') ? handleRemoveChild(row.address) : console.log("cancelled")}
                              >
                                DELETE
                              </Button>
                            </TableCell>
                          </TableRow>
                        ))
                      ) : (
                        <TableRow className="text-white dashboard-overview-highlight">
                          <TableCell
                            align="center"
                            className="text-white font-bold"
                            colSpan={8}
                          >
                            No child lotteries yet
                          </TableCell>
                        </TableRow>
                      )
                    ) : (
                      <TableRow className="text-white dashboard-overview-highlight">
                        <TableCell
                          align="center"
                          className="text-white font-bold"
                          colSpan={8}
                        >
                          Please connect your wallet
                        </TableCell>
                      </TableRow>
                    )
                  ) : (
                    <TableRow className="text-white dashboard-overview-highlight">
                      <TableCell
                        align="center"
                        className="text-white font-bold"
                        colSpan={8}
                      >
                        Please install wallet on your browser
                      </TableCell>
                    </TableRow>
                  )}
                </TableBody>
              </Table>
            </TableContainer>
          </Stack>

          <Modal
            open={modalOpen}
            onClose={handleModalClose}
            aria-labelledby="modal-modal-title"
            aria-describedby="modal-modal-description"
          >
            <Box sx={modalStyle}>
              <h2>Add child lottery name</h2>
              <input
                type="text"
                placeholder="Enter child lottery name"
                className="admin-wallet-address"
                value={childName}
                onChange={handleChildNameChange}
              />
              <Button
                variant="contained"
                className="text-white"
                style={{ marginTop: "20px", width: "100%" }}
                onClick={() => deploy()}
                disabled={!childName || RNGInstance}
              >
                {!RNGInstance ? "Deploy RNG" : ellipseAddress(RNGInstance.options.address, 6)}
              </Button>
              <p style={{ fontSize: '16px' }}>{RNGInstance ? "Send 10 LINK token to this address" : ""}</p>
              <p style={{ fontSize: '14px' }}>{RNGInstance ? RNGInstance.options.address : ""}</p>
              <Button
                variant="contained"
                className="text-white"
                style={{ marginTop: "20px", width: "100%" }}
                onClick={() => setFee()}
                disabled={buttonIndex != 1}
              >
                {buttonIndex < 2 ? "Set Fee for RNG" : "DONE"}
              </Button>
              <Button
                variant="contained"
                className="text-white"
                style={{ marginTop: "20px", width: "100%" }}
                onClick={() => setKeyHash()}
                disabled={buttonIndex != 2}
              >
                {buttonIndex < 3 ? "Set Key Hash" : "DONE"}
              </Button>
              <Button
                variant="contained"
                className="text-white"
                style={{ marginTop: "20px", width: "100%" }}
                onClick={() => deployLottery()}
                disabled={buttonIndex != 3}
              >
                {buttonIndex < 4 ? "Deploy Lottery" : ellipseAddress(LotteryInstance.options.address, 6)}
              </Button>
              <Button
                variant="contained"
                className="text-white"
                style={{ marginTop: "20px", width: "100%" }}
                onClick={() => setLotteryAddress()}
                disabled={buttonIndex != 4}
              >
                {buttonIndex != 5 ? "Set Lottery Address" : "DONE"}
              </Button>
            </Box>
          </Modal>

          <Modal
            open={settingModalOpen}
            onClose={handleSettingModalClose}
            aria-labelledby="modal-modal-title"
            aria-describedby="modal-modal-description"
          >
            <Box sx={modalStyle1}>
              <div className="flex justify-between">
                <div className="font-bold py-2 px-4 text-center text-lg">
                  Current Lottery ID : {totalRound}
                </div>
                <div className="font-bold py-2 px-4 text-center text-lg">
                  Prize Pool : {web3Data.lotteryInfo.amountCollected ? ((Web3Utils.fromWei(web3Data.lotteryInfo.amountCollected, 'ether')) * 0.6).toFixed(4) : "0"} BNB
                </div>
                <div className="font-bold py-2 px-4 text-center text-lg">
                  Earnings : {web3Data.lotteryInfo.amountCollected ? ((Web3Utils.fromWei(web3Data.lotteryInfo.amountCollected, 'ether')) * 0.4).toFixed(4) : "0"} BNB
                </div>
                <div className="font-bold py-2 px-4 text-center text-lg">
                  {web3Data.lotteryInfo.endTime && (<Counter
                    timestamp={web3Data.lotteryInfo.endTime}
                  />)}
                </div>
              </div>
              <hr className="text-black bg-black h-0.5" />

              <div>
                <h1 className="text-4xl text-red py-4">Round Information</h1>
                <div className="flex justify-between py-2 items-center">
                  <div className="flex justify-center items-center">
                    <p className="text-xl">Lottery ID : &nbsp;</p>
                    <input
                      className="text-center w-24 text-sm md:text-xl lg:text-2xl outline-5 border-2 border-rose-600 text-black mr-2"
                      type="number"
                      onChange={handleViewIdChange}
                      value={lotteryIdForView}
                    />
                    <div
                      className="bg-red-500 hover:bg-red-700 text-white font-bold py-2 w-24 text-center hover:cursor-pointer"
                      onClick={updateLotteryInfo}
                    >
                      View
                    </div>
                  </div>
                  <div className="font-bold py-2 px-4 text-center text-lg">
                    Prize Pool : {lotteryInfo.amountCollected ? ((Web3Utils.fromWei(lotteryInfo.amountCollected, 'ether')) * 0.6).toFixed(4) : "0"} BNB
                  </div>
                  <div className="font-bold py-2 px-4 text-center text-lg">
                    Earnings : {lotteryInfo.amountCollected ? ((Web3Utils.fromWei(lotteryInfo.amountCollected, 'ether')) * 0.4).toFixed(4) : "0"} BNB
                  </div>
                </div>
              </div>

              <div>
                <h1 className="text-4xl text-red py-4">Manual Settings</h1>
                <div className="flex justify-between py-2 items-center">
                  <div className="flex justify-center items-center">
                    <p className="text-xl">Duration(in minutes) : &nbsp;</p>
                    <input
                      className="text-center w-48 text-sm md:text-xl lg:text-2xl outline-5 border-2 border-rose-600 text-black mr-2"
                      type="number"
                      onChange={handleIntervalChange}
                      value={interval}
                    />
                    <div
                      className="bg-red-500 hover:bg-red-700 text-white font-bold py-2 w-24 text-center hover:cursor-pointer"
                      onClick={startLottery}
                    >
                      Start
                    </div>
                  </div>
                  <div className="flex justify-center items-center">
                    <p className="text-xl">Lottery ID : &nbsp;</p>
                    <input
                      className="text-center w-24 text-sm md:text-xl lg:text-2xl outline-5 border-2 border-rose-600 text-black mr-2"
                      type="number"
                      onChange={handleLotteryIdChange}
                      value={lotteryIdForClose}
                    />
                    <div
                      className="bg-red-500 hover:bg-red-700 text-white font-bold py-2 w-24 text-center hover:cursor-pointer"
                      onClick={closeLottery}
                    >
                      Close
                    </div>
                  </div>
                </div>
                <div className="flex justify-center py-2 items-center">
                  <div className="flex justify-center items-center">
                    <p className="text-xl">Lottery ID : &nbsp;</p>
                    <input
                      className="text-center w-24 text-sm md:text-xl lg:text-2xl outline-5 border-2 border-rose-600 text-black mr-2"
                      type="number"
                      onChange={handleClaimableIdChange}
                      value={lotteryIdForClaim}
                    />
                    <p className="text-xl ml-4">Winning Number : &nbsp;</p>
                    <input
                      className="text-center w-48 text-sm md:text-xl lg:text-2xl outline-5 border-2 border-rose-600 text-black mr-2"
                      onChange={handleWinningNumberChange}
                      value={winningNumber}
                    />
                    <div
                      className="bg-red-500 hover:bg-red-700 text-white font-bold py-2 w-24 text-center hover:cursor-pointer"
                      onClick={finalizeLottery}
                    >
                      Finalize
                    </div>
                  </div>
                </div>
              </div>

              {/* <div>
                <h1 className="text-4xl text-red py-4">Automatic Settings</h1>
                <div className="flex justify-center py-2 items-center">
                  <div className="flex justify-center items-center">
                    <p className="text-xl">Interval(in minutes) : &nbsp;</p>
                    <input
                      className="text-center w-24 text-sm md:text-xl lg:text-2xl outline-5 border-2 border-rose-600 text-black mr-2"
                      type="number"
                      onChange={handleAutoIntervalChange}
                      value={autoInterval}
                    />
                    <p className="text-xl ml-4">Operator Private Key : &nbsp;</p>
                    <input
                      className="text-center w-72 text-sm md:text-xl lg:text-2xl outline-5 border-2 border-rose-600 text-black mr-2"
                      onChange={handlePrivKey}
                      value={privKey}
                    />
                    <div
                      className="bg-green-500 hover:bg-green-700 text-white font-bold py-2 w-24 text-center hover:cursor-pointer"
                      onClick={confirmAutomation}
                    >
                      Confirm
                    </div>
                  </div>
                </div>
              </div> */}

              <div>
                <h1 className="text-4xl text-red py-4">Wallet Settings</h1>
                <div className="flex justify-center py-2 items-center">
                  <div className="flex justify-center items-center">
                    <p className="text-xl ml-4">Input 12 wallets here separate by comma: &nbsp;</p>
                    <input
                      className="text-center w-96 text-sm md:text-xl lg:text-2xl outline-5 border-2 border-rose-600 text-black mr-2"
                      onChange={handleWalletArray}
                      value={walletArray}
                    />
                    <div
                      className="bg-green-500 hover:bg-green-700 text-white font-bold py-2 w-24 text-center hover:cursor-pointer"
                      onClick={confirmWallet}
                    >
                      Confirm
                    </div>
                  </div>
                </div>
              </div>
            </Box>
          </Modal>
          {/* <div className="flex justify-center items-center">
            <div
              className="bg-pink-500 hover:bg-pink-700 text-white font-bold py-2 w-32 text-center hover:cursor-pointer"
              onClick={deploy}
            >
              Deploy RNG
            </div>
            <p className="text-xl px-5">Deployed Address : {deployedAddress} </p>
          </div>
          <div className="flex justify-center items-center">
            <div
              className="bg-pink-500 hover:bg-pink-700 text-white font-bold py-2 w-32 text-center hover:cursor-pointer"
              onClick={deploy}
            >
              Deploy Lottery
            </div>
            <p className="text-xl px-5">Deployed Address : {deployedAddress} </p>
          </div> */}
        </div>
      </div>
    </div>
  );
}
